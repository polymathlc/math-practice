<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG Math Exam Bank (Pro Layout)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Roboto:wght@400;700&display=swap');

        :root {
            --bg: #eef2f3;
            --bg-gradient: linear-gradient(135deg, #eef2f3 0%, #e6e9f0 100%);
            --paper: #ffffff;
            --text: #2d3436;
            --text-secondary: #636e72;
            --accent: #0984e3;
            --highlight: #74b9ff;
            --success: #00b894;
            --error: #d63031;
            --admin: #6c5ce7;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: 1px solid rgba(255, 255, 255, 0.3);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --card-radius: 16px;
        }

        body.dark-mode {
            --bg: #2d3436;
            --bg-gradient: linear-gradient(135deg, #2d3436 0%, #000000 100%);
            --paper: #1e272e;
            --text: #dfe6e9;
            --text-secondary: #b2bec3;
            --accent: #74b9ff;
            --highlight: #0984e3;
            --glass-bg: rgba(30, 39, 46, 0.8);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .question-block,
        body.dark-mode .focus-card,
        body.dark-mode .result-card,
        body.dark-mode .control-bar {
            background: var(--paper);
            color: var(--text);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        body.dark-mode .sheet {
            background: var(--paper);
            color: var(--text);
        }

        body.dark-mode input,
        body.dark-mode select {
            background: #2d3436;
            color: white;
            border-color: #636e72;
        }

        body.dark-mode .canvas-toolbar {
            background: #2d3436;
            border-color: #636e72;
        }

        body.dark-mode canvas {
            filter: invert(1) hue-rotate(180deg);
        }

        body.dark-mode .grid-bg {
            background-image: linear-gradient(#444 1px, transparent 1px), linear-gradient(90deg, #444 1px, transparent 1px);
        }

        body.large-text {
            font-size: 1.2rem;
        }

        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.1);
            z-index: 9999;
            display: none;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--highlight), var(--accent));
            width: 0%;
            transition: width 0.5s ease;
        }

        @media (max-width: 768px) {
            .control-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 15px;
            }

            .control-group {
                width: 100%;
                margin-right: 0;
            }
        }

        /* Generation Modal Styles */
        .gen-modal-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 80vh;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #eee;
        }

        .filter-section h3 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .checkbox-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: color 0.2s;
        }

        .checkbox-item:hover {
            color: var(--accent);
        }

        .checkbox-item input {
            width: auto;
            cursor: pointer;
        }

        .gen-footer {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .count-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #eee;
            margin-top: 10px;
        }

        .gen-btn-primary {
            background: linear-gradient(135deg, var(--accent), #0773c5);
            padding: 12px 30px;
        }

        .mistake-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: #fff3f0;
            border-radius: 8px;
            border: 1px solid #ffdcd3;
            margin-bottom: 20px;
            cursor: pointer;
        }


        @media print {

            .app-sidebar,
            .canvas-toolbar,
            .toast,
            .progress-container,
            .action-btn,
            .insert-bar,
            .btn-remove,
            .btn-delete-db,
            .vault-badge {
                display: none !important;
            }

            body {
                padding: 0;
                background: white;
                color: black;
            }

            .question-wrapper {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                border: none;
                box-shadow: none;
                margin-bottom: 40px;
                display: block;
            }

            .question-block {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            .working-space-container {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }

            .sheet {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }

            video {
                display: none !important;
            }

            .qr-code {
                display: block !important;
                margin-top: 10px;
            }
        }

        .qr-code {
            display: none;
        }

        .question-mark {
            font-family: 'Roboto', sans-serif;
            font-weight: 700;
        }

        .page-break-before {
            page-break-before: always;
            margin-top: 50px;
        }

        .streak-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #ff9f43, #ee5253);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(238, 82, 83, 0.4);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 8px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% {
                transform: scale(0);
            }

            100% {
                transform: scale(1);
            }
        }

        .streak-shake {
            animation: shake 0.5s;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 99999;
        }

        .stat-weak {
            background: var(--error) !important;
        }

        .stat-ok {
            background: #f1c40f !important;
        }

        .stat-good {
            background: var(--success) !important;
        }

        .grid-bg {
            background-image: linear-gradient(#ccc 1px, transparent 1px), linear-gradient(90deg, #ccc 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: white;
        }

        body.dyslexia-font {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif !important;
            line-height: 1.6;
            word-spacing: 0.1em;
        }

        .focus-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }

        .focus-card {
            background: var(--paper);
            padding: 40px;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .focus-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .student-name-input {
            border: none;
            border-bottom: 2px solid #ccc;
            background: transparent;
            font-size: 1.2rem;
            width: 250px;
            padding: 5px;
            margin-bottom: 20px;
            outline: none;
            color: var(--text);
        }

        @media print {
            .student-name-input {
                border-bottom: 1px solid black;
            }
        }

        .flag-btn {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .flag-btn.active {
            opacity: 1;
        }

        body {
            font-family: 'Century Gothic', 'Outfit', sans-serif;
            background: var(--bg-gradient);
            color: var(--text);
            line-height: 1.3;
            margin: 0;
            padding: 20px;
            padding-bottom: 150px;
            padding-left: 320px;
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        @media print {
            body {
                padding-left: 0;
            }
        }

        .fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            margin: 0 4px;
            font-size: 0.9em;
        }

        .fraction>span {
            display: block;
            padding: 0 2px;
        }

        .numerator {
            border-bottom: 1px solid #000;
            line-height: 1.2;
        }

        .denominator {
            line-height: 1.2;
        }

        .stats-bar-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .stats-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-label {
            width: 120px;
            text-align: right;
            font-size: 0.9rem;
        }

        .stats-track {
            flex: 1;
            background: #eee;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }

        .stats-fill {
            height: 100%;
            background: var(--highlight);
            width: 0%;
            transition: width 0.5s;
        }

        .stats-val {
            width: 40px;
            font-size: 0.8rem;
        }

        .q-layout {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 15px;
            position: relative;
        }

        .q-number-col {
            flex-shrink: 0;
            font-weight: bold;
            font-size: 1.1rem;
            min-width: 25px;
            text-align: right;
        }

        .q-content-col {
            flex-grow: 1;
            font-size: 1.1rem;
            line-height: 1.6;
            text-align: justify;
            width: 100%;
        }

        .q-image {
            display: block;
            max-width: 100%;
            max-height: 300px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .app-sidebar {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            width: 280px;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            padding: 20px;
            border-right: var(--glass-border);
            box-shadow: var(--glass-shadow);
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
        }

        label {
            font-weight: bold;
            font-size: 0.75rem;
            text-transform: uppercase;
            color: #7f8c8d;
        }

        select,
        input[type="number"],
        input[type="text"] {
            padding: 8px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.95rem;
            width: 100%;
            box-sizing: border-box;
        }

        /* AND/OR TOGGLE */
        .filter-mode-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        .toggle-label {
            font-size: 0.9rem;
            font-weight: bold;
        }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            white-space: nowrap;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            filter: brightness(1.1);
        }

        button.check-btn {
            background-color: var(--success);
        }

        button.check-btn:hover {
            background-color: #27ae60;
        }

        .admin-panel {
            background: white;
            max-width: 210mm;
            margin: 40px auto;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid var(--admin);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .admin-header {
            color: var(--admin);
            margin-top: 0;
        }

        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .admin-btn {
            background-color: var(--admin);
            font-size: 0.9rem;
        }

        .admin-btn:hover {
            background-color: #732d91;
        }

        #paper-container {
            max-width: 210mm;
            margin: 0 auto;
        }

        .sheet {
            background: var(--paper);
            color: var(--text);
            width: 100%;
            min-height: 297mm;
            padding: 20mm;
            margin-bottom: 30px;
            box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            position: relative;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .feedback-icon {
            display: inline-block;
            margin-left: 10px;
            font-size: 1.5rem;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            vertical-align: middle;
        }

        .explanation-box {
            margin-top: 5px;
            padding: 10px;
            background-color: #f0f8ff;
            border-left: 3px solid #3498db;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .school-header {
            text-align: center;
            border-bottom: 2px solid black;
            padding-bottom: 10px;
            margin-bottom: 30px;
            text-transform: uppercase;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .question-block {
            margin-bottom: 30px;
            padding: 20px;
            border: 1.5px solid #eaeaea;
            border-radius: 12px;
            background: white;
            break-inside: avoid;
            page-break-inside: avoid;
            position: relative;
            transition: border-color 0.3s ease;
        }

        .question-block:hover {
            border-color: var(--secondary);
        }

        .question-wrapper:hover .q-actions {
            display: flex;
        }

        /* Adaptive Mode Styling */
        body.adaptive-mode .sheet {
            text-align: center;
            padding-top: 50px;
        }

        body.adaptive-mode .question-wrapper {
            max-width: 800px;
            margin: 0 auto;
        }

        .adaptive-next-msg {
            font-size: 1.5rem;
            color: var(--accent);
            margin-top: 20px;
            font-weight: bold;
            animation: popIn 0.5s;
        }

        .q-actions {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }

        .action-btn {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            border: none;
            opacity: 0.9;
        }

        .feedback-tick {
            display: inline-block;
            margin-left: 10px;
            font-size: 1.8rem;
            color: var(--success);
            font-weight: bold;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            vertical-align: middle;
        }

        .feedback-tick.show {
            opacity: 1;
            transform: scale(1.2);
        }

        .btn-remove {
            background: #95a5a6;
            color: white;
        }

        .btn-delete-db {
            background: #e74c3c;
            color: white;
        }

        .q-meta {
            font-size: 0.7rem;
            color: #95a5a6;
            margin-bottom: 5px;
            font-style: italic;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tag {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .insert-bar {
            height: 10px;
            width: 100%;
            margin: 5px 0;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .insert-bar:hover {
            background-color: #eef2f3;
            height: 25px;
        }

        .insert-bar::after {
            content: "+ Insert Question Here";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            color: var(--highlight);
            display: none;
            font-weight: bold;
        }

        .insert-bar:hover::after {
            display: block;
        }

        .part-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }

        .part-label {
            font-weight: 600;
            min-width: 25px;
            color: var(--secondary);
            font-size: 0.9rem;
        }

        .mcq-container {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .mcq-option {
            display: flex;
            align-items: baseline;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .mcq-option input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .mcq-label {
            font-size: 1.1rem;
        }

        .mcq-print-bracket {
            display: none;
            float: right;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: -30px;
        }

        .mcq-option.correct-choice .mcq-label {
            color: var(--success);
            font-weight: bold;
        }

        .mcq-option.wrong-choice .mcq-label {
            color: var(--error);
            text-decoration: line-through;
        }

        .interaction-area {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .student-input {
            padding: 8px;
            border: 2px solid #bdc3c7;
            border-radius: 4px;
            width: 150px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .student-input:focus {
            outline: none;
            border-color: var(--highlight);
        }

        .student-input.correct {
            border-color: var(--success);
            background-color: #e8f8f5;
        }

        .student-input.wrong {
            border-color: var(--error);
            background-color: #fdedec;
        }

        .print-answer-line {
            display: none;
            margin-top: 40px;
            font-weight: bold;
            font-size: 1.1rem;
            text-align: right;
        }

        .working-space {
            height: 150px;
            width: 100%;
            border: 1px solid transparent;
        }

        .working-space-container {
            margin-top: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fdfdfd;
            position: relative;
        }

        .canvas-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px 10px;
            background: #eee;
            border-bottom: 1px solid #ddd;
            border-radius: 4px 4px 0 0;
        }

        .tool-btn {
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .tool-btn.active {
            background: var(--highlight);
            color: white;
            border-color: var(--highlight);
        }

        .working-canvas {
            display: block;
            width: 100%;
            height: 300px;
            cursor: none;
            touch-action: none;
        }

        .brush-cursor {
            position: fixed;
            width: 4px;
            height: 4px;
            border: 1px solid #000;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            display: none;
            mix-blend-mode: difference;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
        }


        .answer-key-section {
            margin-top: 10px;
            font-weight: bold;
            color: var(--highlight);
            display: none;
            border-top: 1px dashed #ccc;
            padding-top: 5px;
        }

        @media print {
            @page {
                size: A4;
                margin: 15mm;
            }

            body {
                background: white;
                padding: 0;
                margin: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .control-bar,
            .admin-panel,
            .q-actions,
            .insert-bar,
            .canvas-toolbar {
                display: none !important;
            }

            #paper-container {
                width: 100%;
                margin: 0;
            }

            .sheet {
                box-shadow: none;
                margin: 0;
                border: none;
                width: 100%;
                min-height: auto;
                padding: 0;
                page-break-after: always;
                overflow: visible;
            }

            .sheet:last-child {
                page-break-after: auto;
            }

            .interaction-area {
                display: none;
            }

            .mcq-option input[type="radio"] {
                display: none;
            }

            .mcq-print-bracket {
                display: block;
            }

            .print-answer-line.open-ended {
                display: block;
            }

            .working-space-container {
                border: none;
                background: transparent;
            }

            .working-canvas {
                height: 200px;
            }
        }

        @media screen and (max-width: 1024px) {
            body {
                padding: 10px;
                padding-bottom: 100px;
            }

            .control-bar {
                max-width: 100%;
                position: relative;
                top: 0;
                padding: 10px;
                gap: 10px;
            }

            .control-group {
                min-width: 45%;
            }

            #paper-container {
                width: 100%;
            }

            .sheet {
                width: 100%;
                min-height: auto;
                padding: 15px;
                box-sizing: border-box;
            }

            .q-layout {
                flex-direction: column;
                gap: 5px;
            }

            .q-number-col {
                text-align: left;
                width: 100%;
                border-bottom: 1px solid #eee;
                padding-bottom: 2px;
                margin-bottom: 5px;
                color: var(--highlight);
            }

            .q-content-col {
                text-align: left;
            }

            .canvas-toolbar {
                flex-wrap: wrap;
                gap: 8px;
            }

            .tool-btn {
                padding: 8px 12px;
                font-size: 1.4rem;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .tool-slider {
                flex-grow: 1;
                height: 30px;
            }

            .student-input {
                width: 100%;
                font-size: 1.1rem;
            }

            .mcq-label {
                font-size: 1.2rem;
                padding: 5px 0;
            }
        }

        .custom-cursor {
            position: fixed;
            pointer-events: none;
            border: 1px solid #000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
            background: rgba(0, 0, 0, 0.1);
        }

        .working-canvas {
            cursor: none;
        }

        .timer-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.2rem;
            background: rgba(0, 0, 0, 0.05);
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            min-width: 100px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .result-card {
            background: var(--paper);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-overlay.open .result-card {
            transform: scale(1);
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--success) 0%, #eee 0%);
            margin: 0 auto 20px auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--text);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .score-circle::before {
            content: "";
            position: absolute;
            width: 90px;
            height: 90px;
            background: var(--paper);
            border-radius: 50%;
        }

        .score-value {
            z-index: 2;
        }

        .result-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.03);
            padding: 15px;
            border-radius: 10px;
        }

        .stat-item h4 {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .stat-item p {
            margin: 5px 0 0 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(45, 52, 54, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 3000;
            pointer-events: none;
            backdrop-filter: blur(5px);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .count-badge {
            background: var(--error);
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            vertical-align: middle;
            display: inline-block;
        }

        .vault-badge {
            display: inline-block;
            background: var(--error);
            color: white;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 10px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            vertical-align: middle;
        }

        .vault-badge.existing {
            background: var(--admin);
        }

        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
            pointer-events: none;
            z-index: 9999;
            margin-bottom: 5px;
        }

        [data-tooltip]:hover::before {
            opacity: 1;
            visibility: visible;
        }

        /* DATABASE COUNT DISPLAY - NEW FEATURE */
        .db-count-display {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            padding: 10px 14px;
            background: linear-gradient(135deg, rgba(116, 185, 255, 0.15), rgba(9, 132, 227, 0.15));
            border-radius: 10px;
            border: 1px solid rgba(116, 185, 255, 0.3);
        }

        .db-count-display .count-number {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--accent);
        }

        body.dark-mode .db-count-display {
            background: linear-gradient(135deg, rgba(116, 185, 255, 0.1), rgba(9, 132, 227, 0.1));
            border-color: rgba(116, 185, 255, 0.2);
        }

        /* SEARCH MODAL - IMPROVED */
        #searchModal {
            z-index: 11000;
        }

        #searchModal .focus-card {
            background: var(--paper);
            color: var(--text);
        }

        .search-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-input-wrapper input[type="text"] {
            flex: 1;
            padding: 14px 18px;
            font-size: 1.1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-input-wrapper input[type="text"]:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(9, 132, 227, 0.15);
        }

        .search-clear-btn {
            padding: 14px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.2s;
        }

        .search-clear-btn:hover {
            background: #c0392b;
        }

        .search-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 10px;
        }

        .search-filters select {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
        }

        .search-result-item {
            border: 1px solid #e0e0e0;
            padding: 18px;
            margin-bottom: 14px;
            border-radius: 12px;
            background: var(--bg);
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }

        .search-result-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            border-color: var(--accent);
        }

        .search-result-meta {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 10px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .search-result-question {
            margin-bottom: 12px;
            line-height: 1.6;
            font-size: 1.05rem;
        }

        .search-result-answer {
            font-size: 0.9rem;
            color: var(--success);
            margin-bottom: 12px;
            padding: 10px 12px;
            background: rgba(0, 184, 148, 0.1);
            border-radius: 8px;
        }

        .search-highlight {
            background: #fff3cd;
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: 600;
        }

        .search-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 2px solid #eee;
            margin-bottom: 18px;
        }

        .search-stats-count {
            font-weight: bold;
            color: var(--accent);
            font-size: 1.1rem;
        }

        .search-no-results {
            text-align: center;
            padding: 50px 20px;
            color: #aaa;
        }

        .search-no-results-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .add-to-paper-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .add-to-paper-btn:hover {
            background: #0773c5;
            transform: translateY(-1px);
        }

        .add-to-paper-btn.added {
            background: var(--success);
            cursor: default;
        }

        .add-to-paper-btn.added:hover {
            transform: none;
        }

        body.dark-mode .search-result-item {
            background: #2d3436;
            border-color: #444;
        }

        body.dark-mode .search-input-wrapper input[type="text"] {
            background: #2d3436;
            color: white;
            border-color: #555;
        }

        body.dark-mode .search-filters {
            background: rgba(255, 255, 255, 0.05);
        }

        body.dark-mode .search-filters select {
            background: #2d3436;
            color: white;
            border-color: #555;
        }

        body.dark-mode .search-highlight {
            background: #5a4a00;
            color: #fff;
        }

        /* Browse Modal Styles */
        .spinner-browse {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 168, 255, 0.2);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .browse-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid #eee;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .browse-item:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }

        .browse-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #7f8c8d;
        }

        .browse-item-q {
            font-size: 0.95rem;
            margin-bottom: 10px;
            line-height: 1.4;
            color: #2d3436;
        }

        .browse-item-footer {
            display: flex;
            justify-content: flex-end;
        }

        body.dark-mode .browse-item {
            background: #2d3436;
            border-color: #444;
        }

        body.dark-mode .browse-item-q {
            color: #ecf0f1;
        }

        body.dark-mode #browseList {
            background: #1e272e;
            border-color: #333;
        }

        /* Question Preview Modal Styles */
        #previewModalContainer {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            padding: 25px;
            max-width: 800px;
            width: 90%;
            height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        body.dark-mode #previewModalContainer {
            background: #1e272e;
            color: #ecf0f1;
        }

        .preview-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .preview-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        body.dark-mode .preview-section {
            border-bottom-color: #333;
        }

        .add-to-paper-btn:active {
            transform: scale(0.95);
        }

        /* Cover Page Styles */
        .cover-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            min-height: 100%;
        }

        .cover-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            font-family: 'Century Gothic', sans-serif;
        }

        .cover-table th,
        .cover-table td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
        }

        .cover-table th {
            background-color: #f8f9fa;
            color: #333;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .cover-table td {
            font-size: 0.9rem;
            color: #444;
        }

        .cover-table .sn-col {
            width: 50px;
            text-align: center;
        }

        .cover-table .marks-col {
            width: 100px;
            text-align: center;
            background: #fafafa;
        }

        .marks-blank {
            display: block;
            height: 25px;
            border-bottom: 1px solid #ccc;
            width: 60%;
            margin: 0 auto;
        }

        .cover-section-title {
            margin-top: 40px;
            font-size: 1.4rem;
            color: var(--secondary);
            font-weight: bold;
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 5px;
            width: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>

<body>
    <div id="auth-overlay"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:99999; display:flex; justify-content:center; align-items:center; font-family:'Outfit', sans-serif; overflow-y: auto;">
        <div
            style="width:100%; max-width:450px; padding:30px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.1); border:1px solid #eee; text-align:center; margin: 20px;">
            <img src="https://www.dropbox.com/scl/fi/pmks0l77qiyuw781sh9t3/polymath-sticker.png?rlkey=jmbai9hxsaggsnua6dwewz5c6&raw=1"
                style="max-width:100px; margin-bottom:15px;">
            <h2 id="auth-title" style="margin-bottom: 20px;">Welcome Back!</h2>

            <div id="reg-fields" style="display:none;">
                <input type="text" id="parent-name" placeholder="Parent's Full Name"
                    style="width:100%; padding:10px; margin:5px 0; border:1px solid #ddd; border-radius:8px;">
                <input type="text" id="student-name" placeholder="Student's Full Name"
                    style="width:100%; padding:10px; margin:5px 0; border:1px solid #ddd; border-radius:8px;">

                <div style="display:flex; gap:10px; margin: 5px 0;">
                    <select id="student-level" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
                        <option value="">Select Level</option>
                        <option value="P3">Primary 3</option>
                        <option value="P4">Primary 4</option>
                        <option value="P5">Primary 5</option>
                        <option value="P6">Primary 6</option>
                        <option value="S1">Secondary 1</option>
                    </select>
                    <select id="student-subject" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:8px;">
                        <option value="">Subject</option>
                        <option value="Math">Math</option>
                        <option value="Science">Science</option>
                    </select>
                </div>
            </div>

            <input type="email" id="auth-email" placeholder="Email"
                style="width:100%; padding:10px; margin:5px 0; border:1px solid #ddd; border-radius:8px;">
            <input type="password" id="auth-pass" placeholder="Password"
                style="width:100%; padding:10px; margin:5px 0; border:1px solid #ddd; border-radius:8px;">

            <div id="legal-box"
                style="display:none; text-align:left; margin:15px 0; background:#f9f9f9; padding:10px; border-radius:8px; font-size:0.8rem; color:#555;">
                <label style="display:flex; gap:10px; cursor:pointer;">
                    <input type="checkbox" id="legal-agree" style="width:20px; height:20px;">
                    <span>I confirm I am a registered student of Polymath Learning Centre and I am lawfully obliged to
                        pay the monthly tuition fees for as long as I am using this application.</span>
                </label>
            </div>

            <button id="btn-login" onclick="handleLogin()"
                style="width:100%; padding:12px; background:#0984e3; color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; margin-top:10px;">Login</button>
            
            <button id="btn-google" onclick="handleGoogleLogin()"
                style="width:100%; padding:12px; background:#fff; color:#757575; border:1px solid #ddd; border-radius:8px; font-weight:600; cursor:pointer; margin-top:10px; display:flex; align-items:center; justify-content:center; gap:10px;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18">
                Sign in with Google
            </button>

            <div style="margin-top:20px; font-size:0.85rem; color:#636e72;">
                <a href="javascript:void(0)" onclick="handleResetPassword()"
                    style="color:#0984e3; text-decoration:none;">Forgot Password?</a><br><br>
                <span id="mode-text">Don't have an account?</span> <a href="javascript:void(0)"
                    onclick="toggleAuthMode()" id="auth-switch"
                    style="color:#0984e3; font-weight:600; cursor:pointer;">Sign Up</a>
            </div>
            <p id="auth-error" style="color:#d63031; font-size:0.8rem; margin-top:15px;"></p>
        </div>
    </div>

    <div id="brush-cursor" class="custom-cursor"></div>

    <aside class="app-sidebar">
        <div style="text-align: center; margin-bottom: 5px;"><img
                src="https://www.dropbox.com/scl/fi/pmks0l77qiyuw781sh9t3/polymath-sticker.png?rlkey=jmbai9hxsaggsnua6dwewz5c6&raw=1"
                style="max-width: 120px; height: auto;"></div>
        <h2 style="margin:0 0 10px 0; color:var(--highlight); text-align:center;">MathGen </h2>

        <div id="dbCountDisplay" class="db-count-display">
             <span class="count-number" id="dbCount">0</span> questions in database
        </div>

        <div class="control-group">
            <label>Search</label>
            <button onclick="openSearchModal()" style="background:var(--admin); flex:1;"> Search</button>
            <button onclick="openBrowseModal()" style="background:var(--accent); flex:1;"> Browse All</button>
        </div>
        <div class="control-group" style="max-width: 100px;">
            <label>Settings</label>
            <div style="display:flex; gap:5px; flex-wrap:wrap;">
                <button onclick="toggleAudio()" id="btn-audio" style="font-size:0.8rem; padding:4px;"
                    data-tooltip="Toggle Sound"></button>
                <button onclick="toggleFontSize()" style="font-size:0.8rem; padding:4px;"
                    data-tooltip="Toggle Font Size">Aa</button>
                <button onclick="toggleDyslexia()" style="font-size:0.8rem; padding:4px;"
                    data-tooltip="Dyslexia Font"></button>
                <button onclick="toggleDarkMode()" style="font-size:0.8rem; padding:4px;" title="Toggle Dark Mode"></button>
                <button onclick="toggleStats()" style="font-size:0.8rem; padding:4px;" data-tooltip="Topic Stats"></button>
            </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="check-btn" onclick="checkAnswers()">Check</button>
            <button onclick="openGenModal()" style="background:var(--accent);">Generate New</button>
            <button onclick="loadMistakePaper()" style="background:#e17055;">Vault <span id="vaultCount"
                    class="count-badge">0</span></button>
            <button onclick="loadFlaggedPaper()" style="background:#f1c40f; color:#000;">Flags <span id="flagCount"
                    class="count-badge">0</span></button>
            <button onclick="window.print()" style="background:#7f8c8d;">Print PDF</button>
            <button onclick="toggleAdmin()" style="background:#8e44ad;">Admin</button>
        </div>
        <div style="margin-top:10px;">
            <button onclick="startAdaptiveMode()"
                style="background: linear-gradient(135deg, #6c5ce7, #a29bfe); width:100%;"> Start Adaptive
                Learning</button>
        </div>
        <div style="display:flex; align-items:center; gap:5px;">
            <input type="checkbox" id="showAnswers" onchange="toggleAnswers()">
            <label for="showAnswers" style="cursor:pointer; color:black; font-size:0.8rem;">Show Key</label>
        </div>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
        <div id="user-info" style="text-align:center; margin-bottom: 10px;">
            <p id="login-days-display" style="font-size:0.9rem; font-weight:bold; color:var(--accent);">Loading days...</p>
        </div>
        <button onclick="handleLogout()"
            style="background:#d63031; width:100%; padding: 10px; border-radius: 8px; color: white; cursor: pointer; font-weight: 600;">
            Logout</button>
    </aside>

    <div id="paper-container">
        <div style="text-align:center; padding:50px; color:#7f8c8d;">
            <h2>Primary Math Generator</h2>
            <p>Database loaded. Click "Generate New" to start.</p>
        </div>
    </div>

    <div class="modal-overlay" id="resultModal">
        <div class="result-card">
            <h2 id="resultTitle">Great Job! </h2>
            <div class="score-circle" id="scoreCircle"><span class="score-value" id="scoreValue">85%</span></div>
            <div class="result-stats">
                <div class="stat-item">
                    <h4>Score</h4>
                    <p id="scoreText">17/20</p>
                </div>
                <div class="stat-item">
                    <h4>Time</h4>
                    <p id="timeText">--:--</p>
                </div>
            </div>
            <p id="resultMessage" style="margin-bottom:20px; color:var(--text-secondary);">Keep it up!</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button onclick="closeModal()" style="background:#bdc3c7; color:#2d3436;">Review</button>
                <button onclick="closeModal(); generateNewPaper();" class="check-btn">New Paper</button>
            </div>
        </div>
    </div>

    <canvas id="confetti-canvas"></canvas>
    <div id="streak-counter" class="streak-container"> <span id="streak-val">0</span></div>

    <div id="stats-modal" class="focus-overlay" style="display:none;">
        <div class="focus-card" style="max-width: 600px;">
            <span class="focus-close" onclick="toggleStats()"></span>
            <h2>Topic Breakdown </h2>
            <div id="stats-content" class="stats-bar-container"></div>
        </div>
    </div>

    <div id="toast" class="toast">Saved!</div>

    <div id="searchModal" class="focus-overlay" style="display:none; align-items:flex-start; padding-top:40px;">
        <div class="focus-card" style="max-width:850px; height:85vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;"> Search Questions</h2>
                <span class="focus-close" onclick="closeSearchModal()"></span>
            </div>
            <div class="search-input-wrapper">
                <input type="text" id="searchInput" placeholder="Search by keyword..." oninput="performSearch()"
                    autofocus>
                <button class="search-clear-btn" onclick="clearSearchInput()">Clear</button>
            </div>
            <div class="search-filters">
                <select id="searchLevelFilter" onchange="performSearch()">
                    <option value="all">All Levels</option>
                    <option value="P1">P1</option>
                    <option value="P2">P2</option>
                    <option value="P3">P3</option>
                    <option value="P4">P4</option>
                    <option value="P5">P5</option>
                    <option value="P6">P6</option>
                </select>
                <select id="searchSchoolFilter" onchange="performSearch()">
                    <option value="all">All Schools</option>
                </select>
                <select id="searchTopicFilter" onchange="performSearch()">
                    <option value="all">All Topics</option>
                </select>
                <select id="searchDiffFilter" onchange="performSearch()">
                    <option value="all">All Difficulties</option>
                    <option value="Easy">Easy</option>
                    <option value="Medium">Medium</option>
                    <option value="Hard">Hard</option>
                </select>
                <label style="display:flex; align-items:center; gap:5px; font-size:0.85rem; color:var(--text); cursor:pointer;">
                    <input type="checkbox" id="searchVideoOnly" onchange="performSearch()"> Video Only 
                </label>
            </div>
            <div id="searchResults" style="flex:1; overflow-y:auto; padding:5px;"></div>
        </div>
    </div>

    <div class="admin-panel" id="adminPanel" style="display:none;">
        <h3 class="admin-header">Admin: Add New Questions</h3>
        <div style="display:flex; gap:15px; margin-bottom:10px;">
            <div style="flex:1">
                <label>Paste JSON (Mass Import)</label>
                <textarea id="importData"></textarea>
                <button class="admin-btn" onclick="importQuestions()">Import JSON</button>
            </div>
            <div style="flex:1; background:#f9f9f9; padding:10px; border-radius:4px;">
                <label>Add Single Question</label>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-bottom:5px;">
                    <input type="text" id="newS" placeholder="School">
                    <input type="text" id="newL" placeholder="Level">
                    <input type="text" id="newT" placeholder="Topic">
                    <input type="text" id="newD" placeholder="Difficulty">
                </div>
                <input type="text" id="newQ" placeholder="Question Text" style="margin-bottom:5px;">
                <input type="text" id="newA" placeholder="Answer" style="margin-bottom:5px;">
                <input type="text" id="newTags" placeholder="Tags (#)" style="margin-bottom:5px;">
                <button class="admin-btn" onclick="addSingleQuestion()">Add Question</button>
            </div>
        </div>
        <button class="admin-btn" style="background:#27ae60;" onclick="exportUpdatedFile()">Export Application Code </button>
    </div>

    <div id="genModal" class="focus-overlay" style="display:none;">
        <div class="focus-card" style="max-width:850px;">
            <span class="focus-close" onclick="closeGenModal()"></span>
            <h2 style="margin:0 0 20px 0;"> Generate New Practice</h2>
            <div class="gen-modal-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <label class="mistake-toggle"><input type="checkbox" id="genIncludeMistakes"> Include <strong>Vault</strong> </label>
                    <div class="filter-mode-toggle">
                        OR <label class="toggle-switch"><input type="checkbox" id="genFilterMode"><span class="slider"></span></label> AND
                    </div>
                </div>
                <div class="filter-grid" id="genFilterGrid">
                    <div class="filter-section"><h3>Level</h3><div class="checkbox-list"><label class="checkbox-item"><input type="checkbox" class="gen-lvl" value="P3"> P3</label><label class="checkbox-item"><input type="checkbox" class="gen-lvl" value="P4"> P4</label><label class="checkbox-item"><input type="checkbox" class="gen-lvl" value="P5"> P5</label><label class="checkbox-item"><input type="checkbox" class="gen-lvl" value="P6"> P6</label><label class="checkbox-item"><input type="checkbox" class="gen-lvl" value="S1"> S1</label></div></div>
                    <div class="filter-section"><h3>Topics</h3><div id="genTopicList" class="checkbox-list"></div></div>
                    <div class="filter-section"><h3>Tags</h3><div id="genTagList" class="checkbox-list"></div></div>
                </div>
                <div class="count-input-wrapper">
                    <label>Number of Questions:</label><input type="number" id="genCount" value="10" min="1" max="50">
                </div>
                <div class="gen-footer">
                    <button onclick="closeGenModal()">Cancel</button>
                    <button onclick="generateAdvancedPaper()" class="gen-btn-primary">Generate </button>
                </div>
            </div>
        </div>
    </div>

    <div id="browseModal" class="focus-overlay" style="display:none; align-items:flex-start; padding-top:40px;">
        <div class="focus-card" style="max-width:900px; height:85vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;"> Browse Questions</h2>
                <span class="focus-close" onclick="closeBrowseModal()"></span>
            </div>
            <div id="browseList" style="flex:1; overflow-y:auto;"></div>
            <div id="browseLoader" style="display:none;">Loading...</div>
        </div>
    </div>

    <div id="questionPreviewModal" class="focus-overlay" style="display:none; z-index:20000;">
        <div id="previewModalContainer">
            <span class="focus-close" onclick="closeQuestionPreview()"></span>
            <div class="preview-section"><div id="prevMeta"></div></div>
            <div class="preview-section"><div id="prevQ"></div><div id="prevImg"></div></div>
            <div class="preview-section"><div id="prevA"></div></div>
            <div class="preview-section" id="prevExpSection"><div id="prevExp"></div></div>
            <div class="preview-section" id="prevVidSection"><div id="prevVid"></div></div>
            <button id="prevAddBtn" class="gen-btn-primary">Add to Worksheet </button>
        </div>
    </div>

    <script id="db-data" type="application/json">
        [
        {
            "s": "Polymath",
            "lvl": "P6",
            "top": "Ratio",
            "dif": "Hard",
            "q": "Mr Toh wants to make 25 small bows and 22 big bows. The length of ribbon used to make 6 big bows is the same as 8 small bows. He managed to make 10 big bows and 16 small bows with 1320 cm of ribbon.<br><br>a) How many small bows can he make with the same length of ribbon needed to make 12 big bows?<br>b) What is the length of ribbon needed to make the remaining bows?",
            "a": "a) 16, b) 1125 cm",
            "u": "",
            "img": "",
            "vid": "https://www.dropbox.com/scl/fi/2hfzanypy0brph9u8ryeu/Screen-Recording-2025-09-17-at-3.18.41-PM.mov?rlkey=bh4dfq57y6hzi248is7426tu4&raw=1",
            "tags": "Ratio, Units, Ribbon",
            "exp": "1. Find the ratio of ribbon for big vs small bows:<br>6 Big = 8 Small -> 3 Big = 4 Small -> 1 Big = 4/3 Small.<br>2. Set units: Let 1 Small = 3u, then 1 Big = 4u.<br>3. Calculate units for the first batch:<br>10 Big + 16 Small = 10(4u) + 16(3u) = 40u + 48u = 88u.<br>4. Find the value of 1u:<br>88u = 1320 cm -> 1u = 1320 / 88 = 15 cm.<br>5. Solve (a):<br>12 Big bows = 12(4u) = 48u.<br>Number of Small bows = 48u / 3u = 16.<br>6. Solve (b):<br>Total needed = 25 Small + 22 Big = 25(3u) + 22(4u) = 75u + 88u = 163u.<br>Remaining = 163u - 88u = 75u.<br>Length = 75 * 15 cm = 1125 cm.",
            "diffScore": 80,
            "id": "q_poly_ribbon_1"
        }
        ]
    </script>

    <script>
        // ============ APP STATE ============
        let db = [];
        let currentPaperQuestions = [];
        let isDrawing = false;
        let browseQList = [];
        let browseIndex = 0;
        const browseBatchSize = 10;
        let isBrowseLoading = false;
        let currentCtx = null;
        let lastX = 0, lastY = 0;
        let currentTool = 'pen';
        let currentLineWidth = 2;
        let searchDebounceTimer = null;
        let addedQuestionIds = new Set();
        let audioEnabled = true;
        let globalStats = JSON.parse(localStorage.getItem('mathGenStats')) || { topics: {}, streak: 0 };
        let mistakeVault = JSON.parse(localStorage.getItem('mathGenVault')) || [];
        let isAdaptiveMode = false;
        let flaggedIds = new Set(JSON.parse(localStorage.getItem('mathGenFlagged')) || []);
        let isReviewMode = false;

        // ============ INIT ============
        window.onload = function () {
            try {
                const rawData = document.getElementById('db-data').textContent;
                db = JSON.parse(rawData);
                db.forEach((q, idx) => { if (!q.id) q.id = 'q_' + idx; });
                updateDbCount();
                updateVaultCount();
                updateFlagCount();
                populateSearchFilters();
            } catch (e) { console.error("DB Load Error", e); }
        };

        // ============ CORE FUNCTIONS ============
        function updateDbCount() { document.getElementById('dbCount').textContent = db.length; }
        function updateVaultCount() { document.getElementById('vaultCount').textContent = mistakeVault.length; }
        function updateFlagCount() { document.getElementById('flagCount').textContent = flaggedIds.size; }

        function formatText(text) {
            if (!text) return '';
            let f = String(text);
            f = f.replace(/\\frac\{([^{}]+)\}\{([^{}]+)\}/gi, (m, n, d) => `<span class="fraction"><span class="numerator">${n}</span><span class="denominator">${d}</span></span>`);
            f = f.replace(/\\div/g, '').replace(/\\times/g, '').replace(/\\angle/gi, '');
            f = f.replace(/\*/g, '');
            return f;
        }

        function parseMCQ(text) {
            if (!text) return { questionText: '', options: [] };
            const parts = text.split(/\s*\([1-4]\)\s*/);
            return parts.length < 2 ? { questionText: text, options: [] } : { questionText: parts[0], options: parts.slice(1) };
        }

        function normalizeAnswer(text) { return String(text).toLowerCase().trim().replace(/[\$\s]/g, ''); }

        function renderQuestionContent(qText, imgUrl) {
            let html = formatText(qText);
            if (imgUrl) html += `<img src="${imgUrl}" class="q-image">`;
            return html;
        }

        function parseMultipartAnswer(ans, unit) {
            const partRegex = /\(([a-zA-Z])\)\s*([^,]+)/g;
            const matches = [...ans.matchAll(partRegex)];
            return matches.length > 0 ? matches.map(m => ({ label: `(${m[1]})`, ans: m[2].trim(), unit: unit || '' })) : [{ label: '', ans: ans, unit: unit || '' }];
        }

        function getDiffColor(dif) {
            const colors = { 'Easy': '#e8f8f5', 'Medium': '#fef9e7', 'Hard': '#fdedec' };
            return colors[dif] || '#f0f0f0';
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ============ AUTH UI TOGGLES ============
        function toggleAuthMode() {
            // Placeholder for UI logic handled by the module script below
            window.dispatchEvent(new CustomEvent('toggleAuth'));
        }

        // ============ SIDEBAR / MODAL ACTIONS ============
        function openSearchModal() { document.getElementById('searchModal').style.display = 'flex'; }
        function closeSearchModal() { document.getElementById('searchModal').style.display = 'none'; }
        function openGenModal() { 
            const topics = [...new Set(db.map(q => q.top))];
            document.getElementById('genTopicList').innerHTML = topics.map(t => `<label class="checkbox-item"><input type="checkbox" class="gen-top" value="${t}"> ${t}</label>`).join('');
            document.getElementById('genModal').style.display = 'flex'; 
        }
        function closeGenModal() { document.getElementById('genModal').style.display = 'none'; }
        function openBrowseModal() { document.getElementById('browseModal').style.display = 'flex'; initBrowseList(); }
        function closeBrowseModal() { document.getElementById('browseModal').style.display = 'none'; }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }
        function toggleFontSize() { document.body.classList.toggle('large-text'); }
        function toggleDyslexia() { document.body.classList.toggle('dyslexia-font'); }
        function toggleStats() { document.getElementById('stats-modal').style.display = 'flex'; }
        function toggleAnswers() { renderPaper(); }
        function closeModal() { document.getElementById('resultModal').classList.remove('open'); }
        function clearSearchInput() { document.getElementById('searchInput').value = ''; }

        // ============ CANVAS LOGIC ============
        function initCanvas(index) {
            const canvas = document.getElementById(`canvas-${index}`);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            ctx.lineCap = 'round'; ctx.lineWidth = 2;
            canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const rect = canvas.getBoundingClientRect();
                lastX = e.clientX - rect.left; lastY = e.clientY - rect.top;
            });
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left; const y = e.clientY - rect.top;
                ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(x, y); ctx.stroke();
                lastX = x; lastY = y;
            });
            window.addEventListener('mouseup', () => isDrawing = false);
        }
        function clearCanvas(index) {
            const c = document.getElementById(`canvas-${index}`);
            c.getContext('2d').clearRect(0,0,c.width,c.height);
        }
        function setTool(btn, tool) { currentTool = tool; }
        function setLineWidth(w) { currentLineWidth = w; }

        // ============ SEARCH/FILTER LOGIC ============
        function populateSearchFilters() {
            const schools = [...new Set(db.map(q => q.s))];
            document.getElementById('searchSchoolFilter').innerHTML = '<option value="all">All Schools</option>' + schools.map(s => `<option value="${s}">${s}</option>`).join('');
        }
        function performSearch() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const res = db.filter(item => item.q.toLowerCase().includes(q));
            document.getElementById('searchResults').innerHTML = res.slice(0,10).map(item => `<div class="search-result-item">${item.q}</div>`).join('');
        }

        // ============ PAPER RENDERING ============
        function generateAdvancedPaper() {
            const count = parseInt(document.getElementById('genCount').value);
            currentPaperQuestions = db.slice(0, count);
            renderPaper();
            closeGenModal();
        }

        function renderPaper() {
            const container = document.getElementById('paper-container');
            container.innerHTML = '';
            currentPaperQuestions.forEach((q, i) => {
                const div = document.createElement('div');
                div.className = 'question-block';
                div.innerHTML = `<h3>Q${i+1}</h3><p>${renderQuestionContent(q.q, q.img)}</p>
                <div class="working-space-container">
                    <div class="canvas-toolbar"><button onclick="clearCanvas(${i})">Clear</button></div>
                    <canvas id="canvas-${i}" width="700" height="200"></canvas>
                </div>
                <div class="answer-key-section" id="ans-${i}">Ans: ${q.a}</div>`;
                container.appendChild(div);
                initCanvas(i);
            });
            if (document.getElementById('showAnswers').checked) {
                document.querySelectorAll('.answer-key-section').forEach(el => el.style.display = 'block');
            }
        }

        function generateNewPaper() { openGenModal(); }
        function checkAnswers() { document.getElementById('resultModal').classList.add('open'); }
        function checkSingleAnswer(i) { document.getElementById(`tick-${i}`).classList.add('show'); }
        function toggleFlag(id) { flaggedIds.add(id); updateFlagCount(); }
        function removeFromPaper(i) { currentPaperQuestions.splice(i,1); renderPaper(); }
        function loadMistakePaper() {}
        function loadFlaggedPaper() {}
        function startAdaptiveMode() {}
        function toggleAdmin() { document.getElementById('adminPanel').style.display = 'block'; }
        function importQuestions() {}
        function addSingleQuestion() {}
        function exportUpdatedFile() {}
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAUSI3Uh28IeqASEp0JhH4QPaVt-O3meBo",
            authDomain: "mathgen--app.firebaseapp.com",
            projectId: "mathgen--app",
            storageBucket: "mathgen--app.firebasestorage.app",
            messagingSenderId: "165654161198",
            appId: "1:165654161198:web:16c8bd60eb3a2aa7edbcbf",
            measurementId: "G-0MWZFG211D"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db_fs = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        let isSignUpMode = false;

        window.toggleAuthMode = () => {
            isSignUpMode = !isSignUpMode;
            const regFields = document.getElementById('reg-fields');
            const legalBox = document.getElementById('legal-box');
            const googleBtn = document.getElementById('btn-google');
            
            document.getElementById('auth-title').innerText = isSignUpMode ? "Register Student Account" : "Welcome Back!";
            document.getElementById('btn-login').innerText = isSignUpMode ? "Confirm Registration" : "Login";
            document.getElementById('auth-switch').innerText = isSignUpMode ? "Login" : "Sign Up";
            document.getElementById('mode-text').innerText = isSignUpMode ? "Already a student?" : "Don't have an account?";
            
            regFields.style.display = isSignUpMode ? "block" : "none";
            legalBox.style.display = isSignUpMode ? "block" : "none";
            googleBtn.style.display = isSignUpMode ? "none" : "flex"; 
            document.getElementById('auth-error').innerText = "";
        };

        async function trackLoginDays(user) {
            const userRef = doc(db_fs, "users", user.uid);
            const today = new Date().toDateString();
            try {
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    const data = userSnap.data();
                    if (data.lastLoginDate !== today) {
                        await updateDoc(userRef, { loginDays: increment(1), lastLoginDate: today });
                        document.getElementById('login-days-display').innerText = ` Day ${(data.loginDays || 0) + 1} streak!`;
                    } else {
                        document.getElementById('login-days-display').innerText = ` Day ${data.loginDays} streak!`;
                    }
                } else {
                    await setDoc(userRef, { email: user.email, studentName: user.displayName || "Student", loginDays: 1, lastLoginDate: today, registrationDate: Date.now() });
                    document.getElementById('login-days-display').innerText = ` Day 1 streak!`;
                }
            } catch (e) { console.error("DB Error", e); }
        }

        window.handleLogin = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-pass').value;
            const errorMsg = document.getElementById('auth-error');
            if(!email || !pass) { errorMsg.innerText = "Enter email and password."; return; }
            try {
                if (isSignUpMode) {
                    const pName = document.getElementById('parent-name').value;
                    const sName = document.getElementById('student-name').value;
                    const agreed = document.getElementById('legal-agree').checked;
                    if(!pName || !sName || !agreed) { errorMsg.innerText = "Fill all fields and agree to terms."; return; }
                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await setDoc(doc(db_fs, "users", cred.user.uid), { email, parentName: pName, studentName: sName, loginDays: 1, lastLoginDate: new Date().toDateString(), agreedToTerms: true });
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (e) { errorMsg.innerText = e.message; }
        };

        window.handleGoogleLogin = async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                await trackLoginDays(result.user);
            } catch (e) { document.getElementById('auth-error').innerText = "Google Error: " + e.message; }
        };

        window.handleLogout = () => signOut(auth).then(() => location.reload());

        window.handleResetPassword = () => {
            const email = document.getElementById('auth-email').value;
            if (!email) { alert("Enter email first."); return; }
            sendPasswordResetEmail(auth, email).then(() => alert("Reset link sent!"));
        };

        onAuthStateChanged(auth, (user) => {
            const overlay = document.getElementById('auth-overlay');
            if (user) { overlay.style.display = 'none'; trackLoginDays(user); }
            else { overlay.style.display = 'flex'; }
        });
    </script>
</body>
</html>
